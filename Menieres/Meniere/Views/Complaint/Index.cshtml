@using Meniere.ViewModels
@using Models
@model ViewModel
@{
    ViewData["Title"] = "吐槽-Meniere";
    ViewData["desc"] = "Meniere-梅尼埃网：耳源性眩晕统计网站";
    ViewData["keyword"] = "Meniere,梅尼埃,眩晕,头晕,美尼尔";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container">
    @{ int num = 1;}
    @foreach (ArticleModel item in Model.ArticleModelList)
    {
        <div class="card">
            <div class="card-header text-left">
                <p style="float:left;width:70%">@item.Author</p>
                <span style="color:gray;text-align:right;float:left;width:30%;font-size:x-small">@(DateTime.Now.Day == item.Date.Day ? item.Date.ToString("HH:mm:ss"): item.Date.ToString("yyyy-MM-dd"))</span>
            </div>
            <div class="card-body">
                <div class="card-text text-left complaint_list">@item.Content</div>
            </div>
        </div>
        <div class="accordion" id="accordionExample_@num">
            <div class="card">
                <div id="headingOne_@num">
                    <h2 class="mb-0">
                        <button class="btn btn-link btn-block text-right" type="button" data-toggle="collapse" data-target="#collapseOne_@num" aria-expanded="true" aria-controls="collapseOne_@num">
                            留言[@((item != null && item.ComplaintList != null) ? item.ComplaintList.Count() : 0)]
                        </button>
                    </h2>
                </div>
                <div id="collapseOne_@num" class="collapse" aria-labelledby="headingOne_@num" data-parent="#accordionExample_@num">
                    <div id="pinglun_@num">
                        @if (item.ComplaintList != null)
                            @foreach (Complaint i in item.ComplaintList)
                            {
                                <a class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <smalll class="text-muted mb-1"><p onclick="AtFun('remark_content_@num','@i.Author')">@@Ta</p></smalll>
                                        <h5 class="mb-1">@i.Author</h5>
                                        <small>@(DateTime.Now.Day == i.Date.Day ? i.Date.ToString("HH:mm:ss"): i.Date.ToString("yyyy-MM-dd"))</small>
                                    </div>
                                    <p class="mb-1 complaint_list" style="text-align:left;">@i.Detail</p>
                                    
                                </a>
                            }
                    </div>
                    <div>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">正文</span>
                            </div>
                            <textarea class="form-control" id="remark_content_@num" aria-label="With textarea" maxlength="300"></textarea>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text">昵称</span>
                            </div>
                            <input type="text" id="remark_author_@num" value="@(Model.User)" class="form-control" maxlength="50">
                        </div>
                        <button type="button" onclick="FinishRemark('@item.Guid', '@num')" class="btn btn-outline-success">提交</button>
                    </div>
                </div>
            </div>
            @{ num++; }
        </div>
    }
    <br/>
    <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
            @if (Model.CurrentPage > 1)
            {
                <li class="page-item">
                    <a class="page-link" href="/Complaint/Index?currentPage=@(Model.CurrentPage-1)" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            }
            @for (int i = Model.CurrentPage - 2, j = 5; i <= Model.TotalPage && j > 0; i++, j--)
            {
                if (i > 0)
                    if (Model.CurrentPage == i)
                    {
                        <li class="page-item active" aria-current="page">
                            <a class="page-link" href="#">@i</a>
                        </li>
                    }
                    else
                    {
                        <li class="page-item"><a class="page-link" href="/Complaint/Index?currentPage=@i">@i</a></li>
                    }
            }
            @if (Model.CurrentPage < Model.TotalPage)
            {
                <li class="page-item">
                    <a class="page-link" href="/Complaint/Index?currentPage=@(Model.CurrentPage+1)" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            }
        </ul>
    </nav>
    <br />
    <div>
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text">正文</span>
            </div>
            <textarea class="form-control" id="complaint_content" aria-label="With textarea" maxlength="4000"></textarea>
        </div>
        <div class="input-group mb-3">
            <input type="text" id="complaint_author" placeholder="昵称" value="@(Model.User)" class="form-control" maxlength="50">
        </div>
        <button type="button" onclick="FinishComplaint()" class="btn btn-outline-success">吐槽</button>
    </div>
</div>
<script src="~/filter/filter.js"></script>
<script>
    $(function () {
        //将正文的换行符替换
        let list = document.getElementsByClassName('complaint_list');
        for (let i = 0; i < list.length; i++) {
            let temp = ContentReplace(list[i].innerHTML);
            list[i].innerHTML = temp;
        }
    });
    //提交吐槽
    function FinishComplaint() {
        let author = $('#complaint_author').val();
        if (author == '') {
            return tooltipTool('complaint_author', '请留下大名');
        }
        let content = $('#complaint_content').val();
        if (content == '') {
            return tooltipTool('complaint_content', '内容不能为空');
        }
        content = ContentFilter(content);
        $.ajax({
            url: '/Complaint/SaveComplaint',
            type: 'POST',
            data: {
                'Author': author,
                'AuthorEmail': '-',
                'content': content,
                'Title':'吐槽'
            },
            async: 'true',
            success: function (data) {
                if (data.code == 200) {
                    window.location.href = '/Complaint/Index?currentPage=1';
                } else {
                    $('#AlertDiv').text(data.msg);
                    $('#AlertDiv').css('display', '');
                    setTimeout(function () { $('#AlertDiv').css('display', 'none') }, 2500);
                }
            }
        });
    }
    //提交留言
    //id 外键
    function FinishRemark(id, num) {
        let author = $('#remark_author_' + num).val();
        if (author == '') {
            return tooltipTool('remark_author_' + num, '请留下大名');
        }
        let content = $('#remark_content_' + num).val();
        if (content == '') {
            return tooltipTool('remark_content_' + num, '内容不能为空');
        }
        content = ContentFilter(content);
        $.ajax({
            url: '/Complaint/SaveRemark',
            type: 'POST',
            data: {
                'Author': author,
                'AuthorEmail': '-',
                'Detail': content,
                'Fid':id,
                'Picture':'',
                'Attachment':''
            },
            async: 'true',
            success: function (data) {
                if (data.code == 200) {
                    if (data.code == 200) {
                        let comcon = document.getElementById('pinglun_' + num);
                        let temp = comcon.innerHTML;
                        let res = '<a class="list-group-item list-group-item-action">' +
                            '<div class="d-flex w-100 justify-content-between">' +
                            '<h5 class="mb-1">' + data.author + '</h5>' +
                            '<small>' + data.date + '</small>' +
                            '</div>' +
                            '<p class="mb-1 complaint_detail" style="text-align:left;">' + ContentReplace(data.detail) + '</p>' +
                            '</a>';
                        comcon.innerHTML = res + temp;
                        //$('#info_content').val('');
                    //留言板置空
                        $('#remark_content_' + num).val('');
                    } else {
                        $('#AlertDiv').text(data.msg);
                        $('#AlertDiv').css('display', '');
                        setTimeout(function () { $('#AlertDiv').css('display', 'none') }, 2500);
                    }
                }
            }
        });
    }
    //指定留言
    function AtFun(id, name) {
        let con = $('#' + id).val();
        $('#' + id).val(con + ' #@@' + name + '# ');
    }
</script>