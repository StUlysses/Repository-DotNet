@using Meniere.ViewModels
@using Models
@model ViewModel
@{
    ViewData["Title"] = Model.Article.Title + "-Meniere";
    ViewData["desc"] = Model.Article.Title + "Meniere-梅尼埃网：耳源性眩晕统计网站";
    ViewData["keyword"] = "Meniere,梅尼埃,眩晕,头晕,美尼尔";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .LB_Img{
        height:400px
    }
</style>
<div class="container" style="width:100%;height:92%">
    <div class="card" id="info_Article" style="width: 100%;">
        <div class="card-body">
            <h5 class="card-title">@(Model.Article.Title)</h5>
            <h6 class="card-subtitle mb-2 text-muted text-right">@(Model.Article.Date.ToString("yyyy-MM-dd HH:mm:ss"))--@(Model.Article.Author)</h6>
        </div>
        @*轮播图*@
        <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
          <ol id="LB_subBtn" class="carousel-indicators"></ol>
          <div id="LB_ImgDiv" class="carousel-inner"></div>
          <button class="carousel-control-prev" type="button" data-target="#carouselExampleIndicators" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
          </button>
          <button class="carousel-control-next" type="button" data-target="#carouselExampleIndicators" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
          </button>
        </div>
    </div>
    <div class="accordion" id="info_accordionExample">
        <div class="card">
            <div id="info_headingOne">
                <h2 class="mb-0">
                    <button class="btn btn-link btn-block text-right" type="button" data-toggle="collapse" data-target="#info_collapseOne" aria-expanded="false" aria-controls="info_collapseOne">
                        留言[@((Model != null && Model.ComplaintList != null) ? Model.ComplaintList.Count() : 0)]
                    </button>
                </h2>
            </div>
            <div class="collapse show" id="info_collapseOne" aria-labelledby="info_headingOne" data-parent="#info_accordionExample">
                <div id="liuyan" class="list-group">
                    @if (Model != null && Model.ComplaintList != null)
                        @foreach (Complaint item in Model.ComplaintList)
                        {
                            <a class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <smalll class="text-muted"><p onclick="AtFun('@item.Author')">@@Ta</p></smalll>
                                    <h5 class="mb-1">@item.Author</h5>
                                    <small>@item.Date.ToString("yyyy-MM-dd")</small>
                                </div>
                                <p class="mb-1 complaint_detail" style="text-align:left;">@item.Detail</p>                               
                            </a>
                        }
                </div>
                <div>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">正文</span>
                        </div>
                        <textarea class="form-control" id="info_content" aria-label="With textarea" maxlength="300"></textarea>
                    </div>
                    <div class="input-group mb-3">
                        <input type="text" id="info_author" placeholder="昵称" value="@(Model.User)" class="form-control" maxlength="50">
                    </div>
                    <button type="button" onclick="Finish()" class="btn btn-outline-success">提交</button>
                </div>
            </div>
        </div>
    </div>
    <br/>
</div>
<script src="~/filter/filter.js"></script>
<script>
    $(function () {
        //将正文的换行符替换
        let con = ContentReplace('@(Model.Article.Content)');
        document.getElementById('info_Article').innerHTML += '<div class="card-text text-left" style="margin:5px">' + con + '</div>';
        //获得图片地址字符
        let imgStr = '@(Model.Article.Attachment)';
        let imgArray = imgStr.split('|');
        for(let i = 0;i < imgArray.length;i++){
            if(imgArray[i].length > 0){
                
                if(i == 0){
                    document.getElementById('LB_ImgDiv').innerHTML += '<div class="carousel-item active"><img src="'+imgArray[i]+'" class="d-block w-100 LB_Img"></div>';
                    document.getElementById('LB_subBtn').innerHTML += '<li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>';
                }
                else{
                    document.getElementById('LB_ImgDiv').innerHTML += '<div class="carousel-item"><img src="'+imgArray[i]+'" class="d-block w-100 LB_Img"></div>';
                    document.getElementById('LB_subBtn').innerHTML += '<li data-target="#carouselExampleIndicators" data-slide-to="'+i+'"></li>';
                }
            }
        }
        
        //对评论进行替换
        let list = $('#info_collapseOne .complaint_detail');
        for (let i = 0; i < list.length; i++) {
            let temp = ContentReplace(list[i].innerHTML);
            list[i].innerHTML = temp;
        }
    });
    //提交留言
    function Finish() {
        var author = $('#info_author').val();
        if (author == '') {
            return tooltipTool('info_author', '请留下大名');
        }
        var content = $('#info_content').val();
        if (content == '') {
            return tooltipTool('info_content', '内容不能为空');
        }
        content = ContentFilter(content);
        $.ajax({
            url: '/Home/SaveMark',
            type: 'POST',
            data: {
                'Author': author,
                'AuthorEmail': '-',
                'Detail': content,
                'Fid':'@(Model.Article.Guid)'
            },
            async: 'true',
            success: function (data) {
                if (data.code == 200) {
                    //window.location.href = '/Home/Info?guid=@(Model.Article.Guid)';
                    var comcon = document.getElementById('liuyan');
                    var temp = comcon.innerHTML;
                    var res = '<a class="list-group-item list-group-item-action">' +
                        '<div class="d-flex w-100 justify-content-between">' +
                        '<h5 class="mb-1">' + data.author + '</h5>' +
                        '<small>' + data.date + '</small>' +
                        '</div>' +
                        '<p class="mb-1 complaint_detail" style="text-align:left;">' + ContentReplace(data.detail) + '</p>' +
                        '</a>';
                    comcon.innerHTML = res + temp;
                    $('#info_content').val('');
                    //重新计算父节点高度
                    //$("#PCBack_div").height($("#PCBack_div").height() + 81);
                    //留言板置空
                    $('#info_content').val('');
                } else {
                    $('#AlertDiv').text(data.msg);
                    $('#AlertDiv').css('display', '');
                    setTimeout(function () { $('#AlertDiv').css('display', 'none') }, 2500);
                }
            }
        });
    }
    //指定留言
    function AtFun(name) {
        var con = $('#info_content').val();
        $('#info_content').val(con + ' #@@' + name + '# ');
    }
</script>